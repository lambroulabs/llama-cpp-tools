name: Build and Release Packages

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-ubuntu:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build \
            debhelper devscripts dpkg-dev \
            nlohmann-json3-dev lcov curl libcurl4-openssl-dev catch2

      - name: Build with CMake + CPack (with coverage)
        run: |
          mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Debug \
                   -DBUILD_EXAMPLES=OFF \
                   -DCMAKE_CXX_FLAGS="--coverage -O0 -g"
          cmake --build . -- -j$(nproc)

      - name: Run tests (Ubuntu)
        run: |
          cd build
          ctest --output-on-failure || true

      - name: Generate coverage report (Ubuntu)
        run: |
          cd build
          lcov --capture --directory . --output-file coverage.info --ignore-errors source,negative
          lcov --remove coverage.info '/usr/*' 'tests/*' --output-file coverage.info --ignore-errors source,negative
          genhtml coverage.info --output-directory coverage-html

      - name: Upload Ubuntu coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-ubuntu
          path: build/coverage-html

      - name: Package with CPack and Debian policy
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build -- -j$(nproc)
          (cd build && cpack -G DEB && cpack -G TGZ)
          ln -s packaging/debian debian
          dpkg-buildpackage -us -uc -b
          mkdir -p deb-out
          mv ../*.deb deb-out/

      - name: Upload Debian artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debian-packages
          path: ${{ github.workspace }}/*.deb

  build-arch:
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: pacman -Syu --noconfirm base-devel git cmake nlohmann-json lcov curl gcc catch2

      - name: Compute SHA256 of release tarball
        run: |
          TAG_NAME=${GITHUB_REF_NAME}
          TAR_NAME="llama-cpp-tools-${TAG_NAME}.tar.gz"
          curl -L -o "$TAR_NAME" \
            "https://github.com/${{ github.repository }}/archive/refs/tags/${TAG_NAME}.tar.gz"
          SHA=$(sha256sum "$TAR_NAME" | awk '{print $1}')
          sed -i "s/sha256sums=('SKIP')/sha256sums=('${SHA}')/" packaging/arch/PKGBUILD

      - name: Build Arch package (with coverage)
        run: |
          mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Debug \
                   -DCMAKE_CXX_FLAGS="--coverage -O0 -g"
          cmake --build . -- -j$(nproc)
          ctest --output-on-failure || true
          lcov --capture --directory . --output-file coverage.info --ignore-errors source,negative
          lcov --remove coverage.info '/usr/*' 'tests/*' --output-file coverage.info --ignore-errors source,negative
          genhtml coverage.info --output-directory coverage-html
          cd ..
          mkdir -p coverage-html/arch
          cp -r build/coverage-html/* coverage-html/arch/
          useradd -m builder
          chown -R builder:builder .
          cd packaging/arch
          su builder -c "makepkg --noconfirm --clean --syncdeps"

      - name: Upload Arch coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-arch
          path: coverage-html/arch

      - name: Upload Arch package
        uses: actions/upload-artifact@v4
        with:
          name: arch-packages
          path: packaging/arch/*.pkg.tar.zst

  upload-coverage:
    runs-on: ubuntu-latest
    needs: [build-ubuntu, build-arch]
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Merge coverage
        run: |
          mkdir -p merged-coverage
          cp -r artifacts/coverage-ubuntu/* merged-coverage/ || true
          cp -r artifacts/coverage-arch/* merged-coverage/ || true

      - name: Upload merged coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: merged-coverage

  release:
    runs-on: ubuntu-latest
    needs: [build-ubuntu, build-arch]
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect Debian packages
        run: |
          mkdir -p artifacts/debian-packages
          mv ../*.deb artifacts/debian-packages/ || true

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            packaging/arch/*.pkg.tar.zst#llama-cpp-tools-${{ github.ref_name }}-arch.pkg.tar.zst
            ./*.deb#llama-cpp-tools-${{ github.ref_name }}-debian.deb

